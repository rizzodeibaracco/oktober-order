<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Oktober Orders – DEBUG (ok25)</title>
    <style>
      :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      body { margin:0; background:#0b0f14; color:#e6eef8; }
      .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
      .card { background:#111826; border:1px solid #1f2a3a; border-radius:16px; padding:16px; }
      .row { display:flex; gap:8px; align-items:center; }
      .input { width:100%; padding:10px; border-radius:12px; border:1px solid #1f2a3a; background:#0f1624; color:#e6eef8; }
      .btn { padding:10px 14px; border-radius:12px; border:1px solid #2a3550; background:#1b2540; color:#e6eef8; cursor:pointer; }
      #errorBox { display:none; background:#4a1f1f; border:1px solid #8a3a3a; color:#ffdede; padding:10px; border-radius:12px; margin:12px 0; white-space:pre-wrap; }
      #okBox { display:none; background:#1f4a2b; border:1px solid #3a8a52; color:#dcffe7; padding:10px; border-radius:12px; margin:12px 0; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Oktober Orders – DEBUG <small>(evento: ok25)</small></h1>
      <div id="errorBox"></div>
      <div id="okBox"></div>

      <div class="card">
        <h2>Nuovo ordine</h2>
        <div class="row">
          <input id="waiterInput" class="input" placeholder="Nome cameriere" />
          <input id="tableInput" class="input" placeholder="Tavolo" />
        </div>
        <div style="margin-top:12px;display:grid;grid-template-columns:1fr 110px;gap:8px;align-items:center">
          <label>Birra bionda 0,5L (6€)</label><input id="qty-bionda05" type="number" min="0" class="input" value="0" />
          <label>Birra bionda 1L (11€)</label><input id="qty-bionda1"  type="number" min="0" class="input" value="0" />
          <label>Birra rossa 0,5L (7€)</label><input id="qty-rossa05"  type="number" min="0" class="input" value="0" />
          <label>Birra rossa 1L (13€)</label><input id="qty-rossa1"   type="number" min="0" class="input" value="0" />
          <label>Non filtrata 0,5L (7€)</label><input id="qty-nf05"     type="number" min="0" class="input" value="0" />
          <label>Non filtrata 1L (13€)</label><input id="qty-nf1"      type="number" min="0" class="input" value="0" />
          <label>Coca-Cola (4€)</label><input id="qty-cola"     type="number" min="0" class="input" value="0" />
          <label>Acqua naturale (2€)</label><input id="qty-nat"      type="number" min="0" class="input" value="0" />
          <label>Acqua frizzante (2€)</label><input id="qty-frizz"    type="number" min="0" class="input" value="0" />
        </div>
        <div class="row" style="justify-content:space-between;margin-top:12px">
          <div id="totalBox"><b>Totale:</b> 0,00€</div>
          <button id="addOrderBtn" type="button" class="btn">➕ Aggiungi ordine</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h2>Ordini</h2>
        <div id="ordersLive"></div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import {
        getFirestore, collection, addDoc, onSnapshot, serverTimestamp,
        updateDoc, doc, deleteDoc, getDocs, writeBatch, query, where
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

      const firebaseConfig = {
  "apiKey": "AIzaSyAZPR5tHdHgbfdhq77SERUBBsH3o3GlFro",
  "authDomain": "oktoberfest-ordes.firebaseapp.com",
  "projectId": "oktoberfest-ordes",
  "storageBucket": "oktoberfest-ordes.firebasestorage.app",
  "messagingSenderId": "836780488125",
  "appId": "1:836780488125:web:a5d99be814b773c7f78ed4"
};
      const EVENT_CODE = "ok25";

      const $ = (id) => document.getElementById(id);
      const showErr = (msg) => { const b=$("errorBox"); b.style.display='block'; b.textContent = "ERRORE: " + msg; };
      const showOk  = (msg) => { const b=$("okBox"); b.style.display='block'; b.textContent = msg; setTimeout(()=>{b.style.display='none'}, 4000); };

      let db;
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        showOk("Firebase inizializzato ✓ (evento: " + EVENT_CODE + ")");
      } catch (e) {
        showErr("Init Firebase fallita: " + e.message);
      }

      const PRICE = { bionda05:6, bionda1:11, rossa05:7, rossa1:13, nf05:7, nf1:13, cola:4, nat:2, frizz:2 };
      const qNum = (id) => Number($(id)?.value || 0);
      const inputs = ["bionda05","bionda1","rossa05","rossa1","nf05","nf1","cola","nat","frizz"];

      function calcTotal(){
        const total = inputs.reduce((s,k)=> s + qNum(`qty-${k}`) * PRICE[k], 0);
        $("totalBox").innerHTML = "<b>Totale:</b> " + total.toFixed(2) + "€";
        return total;
      }
      inputs.forEach(k => $(`qty-${k}`).addEventListener("input", calcTotal));

      function buildOrder(){
        const waiter = $("waiterInput")?.value?.trim();
        const table  = $("tableInput")?.value?.trim();
        const items = [
          ["Birra bionda 0,5L","bionda05"],["Birra bionda 1L","bionda1"],
          ["Birra rossa 0,5L","rossa05"], ["Birra rossa 1L","rossa1"],
          ["Non filtrata 0,5L","nf05"],   ["Non filtrata 1L","nf1"],
          ["Coca-Cola","cola"],           ["Acqua naturale","nat"], ["Acqua frizzante","frizz"],
        ].map(([name,key]) => ({ name, qty: qNum(`qty-${key}`), price: PRICE[key] })).filter(i => i.qty>0);
        const total = calcTotal();
        return { waiter, table, items, total };
      }

      async function salvaOrdine(){
        try {
          const { waiter, table, items, total } = buildOrder();
          if (!waiter || !table) { showErr("Inserisci nome cameriere e tavolo"); return; }
          if (!items.length) { showErr("Aggiungi almeno una quantità"); return; }

          await addDoc(collection(db,"orders"), {
            waiter, table, items, total,
            status: "in_attesa",
            eventCode: EVENT_CODE,
            createdAt: serverTimestamp()
          });

          inputs.forEach(k => { const el = $(`qty-${k}`); if (el) el.value = 0; });
          calcTotal();
          showOk("Ordine inserito ✅");
        } catch (e) {
          console.error(e);
          showErr("Salvataggio fallito: " + (e?.message || e));
        }
      }

      function renderOrdini(ordini){
        const wrap = $("ordersLive");
        if (!wrap) return;
        wrap.innerHTML = "<pre>" + JSON.stringify(ordini, null, 2) + "</pre>";
      }

      try {
        const qEv = query(collection(db,"orders"), where("eventCode","==",EVENT_CODE));
        onSnapshot(qEv, (snap) => {
          const ordini = snap.docs.map(d => ({ id:d.id, ...d.data() }));
          renderOrdini(ordini);
        }, err => showErr("Stream fallito: " + err.message));
      } catch (e) {
        showErr("Snapshot init fallito: " + e.message);
      }

      $("addOrderBtn").addEventListener("click", salvaOrdine);
      calcTotal();

      window.addEventListener('unhandledrejection', (e)=>{
        showErr("Errore non gestito: " + (e.reason?.message || e.reason || ""));
      });
    </script>
  </body>
</html>
