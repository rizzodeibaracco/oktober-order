<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Oktober Orders â€“ Firestore (DEBUG)</title>
    <style>
      :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      body { margin:0; background:#0b0f14; color:#e6eef8; }
      .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
      .grid { display:grid; grid-template-columns:1fr; gap:16px; }
      @media (min-width: 900px){ .grid{ grid-template-columns: 1fr 1fr; } }
      .card { background:#111826; border:1px solid #1f2a3a; border-radius:16px; padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,.25); }
      .row { display:flex; gap:8px; align-items:center; }
      .input, select { width:100%; padding:10px; border-radius:12px; border:1px solid #1f2a3a; background:#0f1624; color:#e6eef8; }
      .btn { padding:10px 14px; border-radius:12px; border:1px solid #2a3550; background:#1b2540; color:#e6eef8; cursor:pointer; }
      .btn:hover { filter:brightness(1.1); }
      .btn.danger { background:#3b1b1b; border-color:#5a2a2a; }
      .total { font-weight:700; font-size:18px; }
      table { width:100%; border-collapse:collapse; }
      th, td { padding:8px; border-bottom:1px solid #223048; text-align:left; vertical-align: top; }
      .badge { padding: 4px 10px; border-radius: 999px; font-size: 12px; border:1px solid #2a3550; }
      .status-wait { background:#2a2540; }
      .status-ready { background:#1f4030; }
      .status-done { background:#31402a; }
      .muted { opacity:.65; }
      #errorBox { display:none; background:#4a1f1f; border:1px solid #8a3a3a; color:#ffdede; padding:10px; border-radius:12px; margin:12px 0; white-space:pre-wrap; }
      #okBox { display:none; background:#1f4a2b; border:1px solid #3a8a52; color:#dcffe7; padding:10px; border-radius:12px; margin:12px 0; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Oktober Orders â€“ Sync (Firestore) <span class="muted">[DEBUG build]</span></h1>
      <div id="errorBox"></div>
      <div id="okBox"></div>

      <div class="grid">
        <div class="card">
          <h2>Nuovo ordine</h2>
          <div class="row">
            <input id="waiterInput" class="input" placeholder="Nome cameriere" />
            <input id="tableInput" class="input" placeholder="Tavolo" />
          </div>
          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 110px;gap:8px;align-items:center">
            <label>Birra bionda 0,5L <span class="muted">(6â‚¬)</span></label><input id="qty-bionda05" type="number" min="0" class="input" value="0" />
            <label>Birra bionda 1L <span class="muted">(11â‚¬)</span></label><input id="qty-bionda1"  type="number" min="0" class="input" value="0" />
            <label>Birra rossa 0,5L <span class="muted">(7â‚¬)</span></label><input id="qty-rossa05"  type="number" min="0" class="input" value="0" />
            <label>Birra rossa 1L <span class="muted">(13â‚¬)</span></label><input id="qty-rossa1"   type="number" min="0" class="input" value="0" />
            <label>Non filtrata 0,5L <span class="muted">(7â‚¬)</span></label><input id="qty-nf05"     type="number" min="0" class="input" value="0" />
            <label>Non filtrata 1L <span class="muted">(13â‚¬)</span></label><input id="qty-nf1"      type="number" min="0" class="input" value="0" />
            <label>Coca-Cola <span class="muted">(4â‚¬)</span></label><input id="qty-cola"     type="number" min="0" class="input" value="0" />
            <label>Acqua naturale <span class="muted">(2â‚¬)</span></label><input id="qty-nat"      type="number" min="0" class="input" value="0" />
            <label>Acqua frizzante <span class="muted">(2â‚¬)</span></label><input id="qty-frizz"    type="number" min="0" class="input" value="0" />
          </div>
          <div class="row" style="justify-content:space-between;margin-top:12px">
            <div id="totalBox" class="total">Totale: 0,00â‚¬</div>
            <button id="addOrderBtn" type="button" class="btn">âž• Aggiungi ordine</button>
          </div>
        </div>

        <div class="card">
          <h2>Ordini</h2>
          <div id="ordersLive"></div>
          <div class="row" style="margin-top:12px;justify-content:flex-end">
            <button id="clearAllBtn" type="button" class="btn danger">ðŸ§¹ Svuota fine serata</button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import {
        getFirestore, collection, addDoc, onSnapshot, serverTimestamp,
        query, orderBy, updateDoc, doc, deleteDoc, getDocs, writeBatch
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

      // CONFIG dell'utente
      const firebaseConfig = {
        apiKey: "AIzaSyAZPR5tHdHgbfdhq77SERUBBsH3o3GlFro",
        authDomain: "oktoberfest-ordes.firebaseapp.com",
        projectId: "oktoberfest-ordes",
        storageBucket: "oktoberfest-ordes.firebasestorage.app",
        messagingSenderId: "836780488125",
        appId: "1:836780488125:web:a5d99be814b773c7f78ed4"
      };

      const $ = (id) => document.getElementById(id);
      const showErr = (msg) => { const b=$("errorBox"); b.style.display='block'; b.textContent = "ERRORE: " + msg; };
      const showOk  = (msg) => { const b=$("okBox"); b.style.display='block'; b.textContent = msg; setTimeout(()=>{b.style.display='none'},4000); };

      let db;
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        showOk("Firebase inizializzato âœ“");
      } catch (e) {
        showErr("Init Firebase fallita: " + e.message);
      }

      const PRICE = { bionda05:6, bionda1:11, rossa05:7, rossa1:13, nf05:7, nf1:13, cola:4, nat:2, frizz:2 };
      const qNum = (id) => Number($(id)?.value || 0);
      const inputs = ["bionda05","bionda1","rossa05","rossa1","nf05","nf1","cola","nat","frizz"];

      function calcTotal(){
        const total = inputs.reduce((s,k)=> s + qNum(`qty-${k}`) * PRICE[k], 0);
        $("totalBox").textContent = `Totale: ${total.toFixed(2)}â‚¬`;
        return total;
      }
      inputs.forEach(k => $(`qty-${k}`).addEventListener("input", calcTotal));

      function buildOrder(){
        const waiter = $("waiterInput")?.value?.trim();
        const table  = $("tableInput")?.value?.trim();
        const items = [
          ["Birra bionda 0,5L","bionda05"],["Birra bionda 1L","bionda1"],
          ["Birra rossa 0,5L","rossa05"], ["Birra rossa 1L","rossa1"],
          ["Non filtrata 0,5L","nf05"],   ["Non filtrata 1L","nf1"],
          ["Coca-Cola","cola"],           ["Acqua naturale","nat"], ["Acqua frizzante","frizz"],
        ].map(([name,key]) => ({ name, qty: qNum(`qty-${key}`), price: PRICE[key] })).filter(i => i.qty>0);
        const total = calcTotal();
        return { waiter, table, items, total };
      }

      async function salvaOrdine(){
        try {
          const { waiter, table, items, total } = buildOrder();
          if (!waiter || !table) { showErr("Inserisci nome cameriere e tavolo"); return; }
          if (!items.length) { showErr("Aggiungi almeno una quantitÃ "); return; }

          await addDoc(collection(db,"orders"), {
            waiter, table, items, total,
            status: "in_attesa",
            createdAt: serverTimestamp()
          });
          inputs.forEach(k => { const el = $(`qty-${k}`); if (el) el.value = 0; });
          calcTotal();
          showOk("Ordine inserito âœ…");
        } catch (e) {
          console.error(e);
          showErr("Salvataggio fallito: " + (e?.message || e));
        }
      }

      const STATI = ["in_attesa","pronto","consegnato"];
      async function avanzaStato(id, statoAttuale){
        try {
          const next = STATI[(STATI.indexOf(statoAttuale)+1) % STATI.length];
          await updateDoc(doc(db,"orders",id), { status: next });
        } catch (e) {
          showErr("Aggiornamento stato fallito: " + e.message);
        }
      }
      async function eliminaOrdine(id){
        try {
          if (!confirm("Eliminare questo ordine?")) return;
          await deleteDoc(doc(db,"orders",id));
        } catch (e) {
          showErr("Eliminazione fallita: " + e.message);
        }
      }
      async function svuotaFineSerata(){
        try {
          if (!confirm("Cancellare TUTTI gli ordini?")) return;
          const snap = await getDocs(collection(db,"orders"));
          const batch = writeBatch(db);
          snap.forEach(d => batch.delete(d.ref));
          await batch.commit();
          showOk("Ordini cancellati");
        } catch (e) {
          showErr("Svuota fallito: " + e.message);
        }
      }

      function renderOrdini(ordini){
        const wrap = $("ordersLive");
        if (!wrap) return;
        wrap.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Ora</th><th>Tavolo</th><th>Cameriere</th><th>Dettagli</th><th>Totale</th><th>Stato</th><th>Azioni</th>
              </tr>
            </thead>
            <tbody>
              ${ordini.map(o => `
                <tr>
                  <td>${o.createdAt?.toDate ? o.createdAt.toDate().toLocaleTimeString() : "-"}</td>
                  <td>${o.table||""}</td>
                  <td>${o.waiter||""}</td>
                  <td>${(o.items||[]).map(i => `${i.qty}Ã— ${i.name}`).join("<br>")}</td>
                  <td>${Number(o.total||0).toFixed(2)}â‚¬</td>
                  <td><span class="badge ${o.status==='in_attesa'?'status-wait':o.status==='pronto'?'status-ready':'status-done'}">${o.status||""}</span></td>
                  <td>
                    <button class="btn" onclick="window._advance('${o.id}','${o.status||"in_attesa"}')">Avanza</button>
                    <button class="btn danger" onclick="window._remove('${o.id}')">Elimina</button>
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
      }

      try {
        const q = query(collection(db,"orders"), orderBy("createdAt","desc"));
        onSnapshot(q, snap => {
          const ordini = snap.docs.map(d => ({ id:d.id, ...d.data() }));
          renderOrdini(ordini);
        }, err => {
          showErr("Stream fallito: " + err.message);
        });
      } catch (e) {
        showErr("Snapshot init fallito: " + e.message);
      }

      $("addOrderBtn").addEventListener("click", salvaOrdine);
      $("clearAllBtn").addEventListener("click", svuotaFineSerata);
      window._advance = avanzaStato;
      window._remove  = eliminaOrdine;
      calcTotal();

      // Catch globale promesse non gestite
      window.addEventListener('unhandledrejection', (e)=>{
        showErr("Errore non gestito: " + (e.reason?.message || e.reason || ""));
      });
    </script>
  </body>
</html>
