<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Oktober Orders ‚Äì ok25</title>
<style>
  :root{
    --bg:#f7fbe9; --card:#ffffff; --text:#1b2b16; --muted:#58734a;
    --primary:#2e7d32; --primary-2:#66bb6a; --border:#d9e8c6;
  }
  *{box-sizing:border-box} html,body{max-width:100%;overflow-x:hidden}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  header.top{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
  .btn{padding:12px 16px;border-radius:14px;border:1px solid var(--primary-2);background:linear-gradient(180deg,var(--primary-2),var(--primary));color:#fff;cursor:pointer;font-size:18px}
  .btn.ghost{background:#fff;color:#2e7d32;border:1px solid #2e7d32}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  .row{display:flex;gap:12px;align-items:center}
  .input{width:100%;padding:14px 16px;border-radius:14px;border:1px solid var(--border);background:#fbfff4;color:var(--text)}
  .qtybox{display:flex;align-items:center;gap:10px;justify-content:flex-end}
  .qtynum{min-width:32px;text-align:center;font-weight:800;font-size:20px}
  .row.item{justify-content:space-between;padding:10px 0;border-bottom:1px dashed var(--border)}
  .label .price{color:#58734a;font-size:14px;margin-left:8px}
  .total{font-weight:900;font-size:22px;background:#fff5cc;border:1px solid #f5e487;border-radius:999px;padding:10px 14px}
  .group{margin-top:8px}
  .group-title{font-weight:900;background:#fff8d6;border:1px solid var(--border);border-radius:10px;padding:8px 10px;margin:8px 0;}
</style>
</head>
<body>
  <div class="container">
    <header class="top">
      <h1 style="margin:0">Oktober Orders <span style="display:inline-block;padding:6px 12px;border:1px solid var(--border);background:#fff8d6;border-radius:999px">evento: ok25</span></h1>
      <a href="./orders.html" class="btn ghost">üìã Ordini</a>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Nuovo ordine</h2>
        <div class="row">
          <input id="waiterInput" class="input" placeholder="Nome cameriere" />
          <input id="tableInput" class="input" placeholder="Tavolo" inputmode="numeric" />
        </div>

        <div id="menuList" style="margin-top:8px"></div>

        <div class="row" style="justify-content:space-between;margin-top:12px">
          <div id="totalBox" class="total">Totale: 0,00‚Ç¨</div>
          <button id="addOrderBtn" type="button" class="btn">‚ûï Aggiungi ordine</button>
        </div>
      </div>

      <div class="card">
        <h2>Ordini (rapido)</h2>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <label for="dayInput">Giornata:</label>
          <input type="date" id="dayInput" class="input" style="max-width:220px" />
          <span style="color:#58734a">Mostro solo gli ordini <b>non eliminati</b> della giornata scelta</span>
        </div>
        <div id="ordersLive"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import {{ initializeApp }} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {{
      getFirestore, collection, addDoc, onSnapshot, serverTimestamp,
      updateDoc, doc, getDocs, writeBatch, query, where
    }} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
  "apiKey": "AIzaSyAZPR5tHdHgbfdhq77SERUBBsH3o3GlFro",
  "authDomain": "oktoberfest-ordes.firebaseapp.com",
  "projectId": "oktoberfest-ordes",
  "storageBucket": "oktoberfest-ordes.firebasestorage.app",
  "messagingSenderId": "836780488125",
  "appId": "1:836780488125:web:a5d99be814b773c7f78ed4"
};
    const EVENT_CODE = "ok25";
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const PRICE = {{
      mass_bionda1: 11, mass_rossa1: 13, mass_nf1: 13,
      bionda05: 6, rossa05: 7, nf05: 7,
      birra_gf: 5, birra_analc05: 4,
      coca: 3, coca_zero: 3, fanta: 3, te_limone: 3, te_pesca: 3,
      acqua_nat: 1.5, acqua_frizz: 1.5,
      torta_sacher: 4, crostata_veg: 4
    }};

    const NAMES = {{
      mass_bionda1: "MASS Wieninger bionda 1 L",
      mass_rossa1: "MASS Wieninger rossa 1 L",
      mass_nf1: "MASS Wieninger non filtrata 1 L",
      bionda05: "Wieninger bionda 0,5 L",
      rossa05: "Wieninger rossa 0,5 L",
      nf05: "Wieninger non filtrata 0,5 L",
      birra_gf: "Birra gluten free",
      birra_analc05: "Birra analcolica 0,5 L",
      coca: "Coca-Cola", coca_zero: "Coca-Cola Zero", fanta: "Fanta",
      te_limone: "T√® al limone", te_pesca: "T√® alla pesca",
      acqua_nat: "Acqua naturale", acqua_frizz: "Acqua frizzante",
      torta_sacher: "Torta Sacher", crostata_veg: "Crostata veg di marmellata"
    }};

    const NAMES_HTML = {{
      mass_bionda1: "<b>üç∫ MASS Wieninger bionda 1 L</b>",
      mass_rossa1: "<b>üç∫ MASS Wieninger rossa 1 L</b>",
      mass_nf1: "<b>üç∫ MASS Wieninger non filtrata 1 L</b>",
      bionda05: "<b>Wieninger bionda 0,5 L</b>",
      rossa05: "<b>Wieninger rossa 0,5 L</b>",
      nf05: "<b>Wieninger non filtrata 0,5 L</b>",
      birra_gf: "<b>Birra gluten free</b>",
      birra_analc05: "<b>Birra analcolica 0,5 L</b>",
      coca: "<b>ü•§ Coca-Cola</b>", coca_zero: "<b>ü•§ Coca-Cola Zero</b>", fanta: "<b>ü•§ Fanta</b>",
      te_limone: "<b>ü•§ T√® al limone</b>", te_pesca: "<b>ü•§ T√® alla pesca</b>",
      acqua_nat: "<b>üíß Acqua naturale</b>", acqua_frizz: "<b>üíß Acqua frizzante</b>",
      torta_sacher: "<b>üç∞ Torta Sacher</b>", crostata_veg: "<b>üç∞ Crostata veg di marmellata</b>"
    }};

    const KEYS = Object.keys(PRICE);
    const state = Object.fromEntries(KEYS.map(k=>[k,0]));

    const GROUPS = [
      {{ title: "üç∫ MASS 1 L", keys: ["mass_bionda1","mass_rossa1","mass_nf1"] }},
      {{ title: "üç∫ 0,5 L", keys: ["bionda05","rossa05","nf05"] }},
      {{ title: "ü•§ Bibite 3‚Ç¨", keys: ["coca","coca_zero","fanta","te_limone","te_pesca"] }},
      {{ title: "üíß Acque 1,50‚Ç¨", keys: ["acqua_nat","acqua_frizz"] }},
      {{ title: "üç∞ Dolci 4‚Ç¨", keys: ["torta_sacher","crostata_veg"] }}
    ];

    const $ = id => document.getElementById(id);
    const pad = n => String(n).padStart(2,"0");
    const ymd = d => d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());

    let CURRENT_DAY = localStorage.getItem("ok25_current_day") || ymd(new Date());
    function applyDayToUI(){{ const input = $("dayInput"); if (input) input.value = CURRENT_DAY; }}
    function setDay(newDay){{ CURRENT_DAY = newDay; localStorage.setItem("ok25_current_day", CURRENT_DAY); renderOrdini(_snapshotCache || []); }}
    applyDayToUI();
    $("dayInput").addEventListener("change", e=> setDay(e.target.value));

    const WAITER_KEY = "ok25_waiter_name";
    function restoreWaiter(){{ const s = localStorage.getItem(WAITER_KEY); if (s && $("waiterInput")) $("waiterInput").value = s; }}
    function persistWaiter(){{ localStorage.setItem(WAITER_KEY, ($("waiterInput")?.value||"").trim()); }}

    function renderMenu(){
      const wrap = $("menuList");
      wrap.innerHTML = GROUPS.map(g => {
        const items = g.keys.map(k => `
          <div class="row item">
            <div class="label">${{NAMES_HTML[k]}} <span class="price">(${{PRICE[k]}}‚Ç¨)</span></div>
            <div class="qtybox">
              <button class="btn" style="background:#fff;color:#2e7d32;border:1px solid #66bb6a" data-key="${{k}}" data-delta="-1">‚Äì</button>
              <span class="qtynum" id="qty-${{k}}">0</span>
              <button class="btn" data-key="${{k}}" data-delta="1">+</button>
            </div>
          </div>`).join("");
        return `<div class="group"><div class="group-title">${{g.title}}</div>${{items}}</div>`;
      }).join("");
      wrap.querySelectorAll("button[data-key]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const key=btn.getAttribute("data-key"); const d=Number(btn.getAttribute("data-delta"));
          state[key]=Math.max(0,(state[key]||0)+d);
          const el=document.getElementById("qty-"+key); if(el) el.textContent=state[key];
          calcTotal();
        });
      });
    }

    function calcTotal(){ const tot = KEYS.reduce((s,k)=> s+(state[k]||0)*PRICE[k],0); $("totalBox").textContent = "Totale: " + tot.toFixed(2) + "‚Ç¨"; return tot; }
    function buildOrder(){ const waiter=$("waiterInput")?.value?.trim(); const table=$("tableInput")?.value?.trim(); const items=KEYS.map(k=>({key:k,name:NAMES[k],qty:state[k]||0,price:PRICE[k]})).filter(i=>i.qty>0); const total=calcTotal(); return {waiter,table,items,total}; }

    async function salvaOrdine(){
      const tableEl=$("tableInput");
      const {waiter,table,items,total}=buildOrder();
      if(!waiter||!table){ alert("Inserisci nome cameriere e tavolo"); return; }
      if(!items.length){ alert("Aggiungi almeno una quantit√†"); return; }
      await addDoc(collection(db,"orders"), {waiter,table,items,total,status:"in_attesa",eventCode:EVENT_CODE,deleted:false,day:CURRENT_DAY,createdAt:serverTimestamp()});
      Object.keys(state).forEach(k=>{state[k]=0; const el=$("qty-"+k); if(el) el.textContent="0";}); calcTotal();
      localStorage.setItem(WAITER_KEY, waiter); if(tableEl){tableEl.value=""; tableEl.focus();}
      alert("Ordine inserito ‚úÖ");
    }

    const STATI=["in_attesa","pronto","consegnato","eliminato"];
    async function avanzaStato(id, s){ const next=STATI[(STATI.indexOf(s)+1)%STATI.length]; await updateDoc(doc(db,"orders",id), {status:next}); }
    async function eliminaOrdine(id){ await updateDoc(doc(db,"orders",id), {deleted:true,status:"eliminato"}); }

    let _snapshotCache=[];
    function renderOrdini(ordini){
      _snapshotCache=ordini;
      const wrap=document.getElementById("ordersLive");
      const vis=ordini.filter(o=>!o.deleted && (o.day||"")===(CURRENT_DAY));
      wrap.innerHTML = vis.map(o=>`
        <div style="border:1px solid var(--border);border-radius:12px;padding:8px;margin:8px 0;background:#fff">
          <div><b>${'{'}${'{'}o.table{'}'}{'}'}</b> ‚Ä¢ ${'{'}${'{'}o.waiter||""{'}'}{'}'}</div>
          <div style="color:#58734a">${'{'}${'{'}(o.items||[]).map(i=>i.qty+"√ó "+i.name).join(", "){'}'}{'}'}</div>
          <div><b>${'{'}${'{'}Number(o.total||0).toFixed(2){'}'}{'}'}‚Ç¨</b> ‚Äî ${'{'}${'{'}o.status{'}'}{'}'}</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn ghost" onclick="window._advance('${'{'}${'{'}o.id{'}'}{'}'}','${'{'}${'{'}o.status{'}'}{'}'}')">Avanza</button>
            <button class="btn" style="background:linear-gradient(180deg,#ef9a9a,#e53935);border:1px solid #e57373" onclick="window._remove('${'{'}${'{'}o.id{'}'}{'}'}')">Elimina</button>
          </div>
        </div>`).join("") || "<div style='opacity:.7'>Nessun ordine oggi.</div>";
    }

    const qEv = query(collection(db,"orders"), where("eventCode","==",EVENT_CODE));
    onSnapshot(qEv, snap=>{ const arr=snap.docs.map(d=>({id:d.id,...d.data()})); arr.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)); renderOrdini(arr); });

    document.getElementById("addOrderBtn").addEventListener("click", salvaOrdine);

    // init
    renderMenu(); calcTotal(); restoreWaiter();
    window._advance=avanzaStato; window._remove=eliminaOrdine;
  </script>
</body>
</html>
