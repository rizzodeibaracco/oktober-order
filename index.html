
<!doctype html><html lang="it"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Oktober Orders ‚Äì ok25 (compat)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#f7fbe9;color:#1b2b16}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .btn{padding:12px 16px;border-radius:14px;border:1px solid #66bb6a;background:linear-gradient(180deg,#66bb6a,#2e7d32);color:#fff;cursor:pointer}
  .btn.ghost{background:#fff;color:#2e7d32;border:1px solid #2e7d32}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid #d9e8c6;border-radius:16px;padding:16px}
  .row{display:flex;align-items:center;gap:12px}
  .input{width:100%;padding:14px 16px;border-radius:14px;border:1px solid #d9e8c6;background:#fbfff4}
  .group{margin-top:12px}.group h3{margin:0 0 8px;font-size:18px;background:#fff8d6;border:1px solid #d9e8c6;padding:8px;border-radius:10px}
  .item{display:flex;align-items:center;justify-content:space-between;border-bottom:1px dashed #d9e8c6;padding:10px 0}
  .qty{display:flex;align-items:center;gap:10px}
  .total{font-weight:900;background:#fff5cc;border:1px solid #f5e487;border-radius:999px;padding:10px 14px}
  .dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:8px}
  .red{background:#ff5252}.green{background:#00c853}
  .blink{animation:blink 1.4s ease-in-out infinite}@keyframes blink{0%,100%{opacity:1}50%{opacity:.45}}
  table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid #d9e8c6;text-align:left;vertical-align:top}
</style></head><body>
<div class="container">
  <h1>Oktober Orders <span style="padding:6px 12px;border:1px solid #d9e8c6;background:#fff8d6;border-radius:999px">ok25</span></h1>

  <div class="grid">
    <div class="card">
      <h2>Nuovo ordine</h2>
      <div class="row">
        <input id="waiterInput" class="input" placeholder="Nome cameriere">
        <input id="tableInput" class="input" placeholder="Tavolo" inputmode="numeric">
      </div>
      <div id="menu"></div>
      <div class="row" style="justify-content:space-between;margin-top:12px">
        <div id="sum" class="total">Totale: 0,00‚Ç¨</div>
        <button id="addBtn" class="btn">‚ûï Aggiungi ordine</button>
      </div>
    </div>

    <div class="card">
      <h2>Ordini</h2>
      <div class="row">
        <label>Giornata: <input id="dayInput" class="input" type="date" style="max-width:220px"></label>
      </div>
      <div id="orders"></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, updateDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  const firebaseConfig = {
  "apiKey": "AIzaSyAZPR5tHdHgbfdhq77SERUBBsH3o3GlFro",
  "authDomain": "oktoberfest-ordes.firebaseapp.com",
  "projectId": "oktoberfest-ordes",
  "storageBucket": "oktoberfest-ordes.firebasestorage.app",
  "messagingSenderId": "836780488125",
  "appId": "1:836780488125:web:a5d99be814b773c7f78ed4"
};

  // --- Compat helpers (no optional chaining) ---
  function tsToDate(ts){ try{ if(ts && typeof ts.toDate === "function") return ts.toDate(); }catch(e){} return new Date(); }
  function fmtTime(ts){ var d=tsToDate(ts); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
  function pad(n){ n=String(n); return n.length<2? "0"+n : n; }
  function ymd(d){ return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate()); }

  const EVENT_CODE="ok25";
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const PRICE={ mass_bionda1:11, mass_rossa1:13, mass_nf1:13, bionda05:6, rossa05:7, nf05:7, birra_gf:5, birra_analc05:4, coca:3, coca_zero:3, fanta:3, te_limone:3, te_pesca:3, acqua_nat:1.5, acqua_frizz:1.5, torta_sacher:4, crostata_veg:4 };
  const NAME={ mass_bionda1:"MASS Wieninger bionda 1 L", mass_rossa1:"MASS Wieninger rossa 1 L", mass_nf1:"MASS Wieninger non filtrata 1 L", bionda05:"Wieninger bionda 0,5 L", rossa05:"Wieninger rossa 0,5 L", nf05:"Wieninger non filtrata 0,5 L", birra_gf:"Birra gluten free", birra_analc05:"Birra analcolica 0,5 L", coca:"Coca-Cola", coca_zero:"Coca-Cola Zero", fanta:"Fanta", te_limone:"T√® al limone", te_pesca:"T√® alla pesca", acqua_nat:"Acqua naturale", acqua_frizz:"Acqua frizzante", torta_sacher:"Torta Sacher", crostata_veg:"Crostata veg di marmellata" };
  const LABEL={ mass_bionda1:"<b>üç∫ MASS Wieninger bionda 1 L</b>", mass_rossa1:"<b>üç∫ MASS Wieninger rossa 1 L</b>", mass_nf1:"<b>üç∫ MASS Wieninger non filtrata 1 L</b>", bionda05:"<b>Wieninger bionda 0,5 L</b>", rossa05:"<b>Wieninger rossa 0,5 L</b>", nf05:"<b>Wieninger non filtrata 0,5 L</b>", birra_gf:"<b>Birra gluten free</b>", birra_analc05:"<b>Birra analcolica 0,5 L</b>", coca:"<b>ü•§ Coca-Cola</b>", coca_zero:"<b>ü•§ Coca-Cola Zero</b>", fanta:"<b>ü•§ Fanta</b>", te_limone:"<b>ü•§ T√® al limone</b>", te_pesca:"<b>ü•§ T√® alla pesca</b>", acqua_nat:"<b>üíß Acqua naturale</b>", acqua_frizz:"<b>üíß Acqua frizzante</b>", torta_sacher:"<b>üç∞ Torta Sacher</b>", crostata_veg:"<b>üç∞ Crostata veg di marmellata</b>" };
  const GROUPS=[
    {title:"üç∫ MASS 1 L", keys:["mass_bionda1","mass_rossa1","mass_nf1"]},
    {title:"üç∫ 0,5 L", keys:["bionda05","rossa05","nf05"]},
    {title:"ü•§ Bibite 3‚Ç¨", keys:["coca","coca_zero","fanta","te_limone","te_pesca"]},
    {title:"üíß Acque 1,50‚Ç¨", keys:["acqua_nat","acqua_frizz"]},
    {title:"üç∞ Dolci 4‚Ç¨", keys:["torta_sacher","crostata_veg"]}
  ];
  var state={}; Object.keys(PRICE).forEach(function(k){state[k]=0;});

  function renderMenu(){
    var wrap=document.getElementById("menu");
    var html="";
    GROUPS.forEach(function(g){
      html+='<div class="group"><h3>'+g.title+'</h3>';
      g.keys.forEach(function(k){
        html+='<div class="item"><div class="label">'+LABEL[k]+' <span style="color:#58734a;font-size:14px">('+(PRICE[k])+'‚Ç¨)</span></div>'+
              '<div class="qty"><button class="btn ghost" data-k="'+k+'" data-d="-1">‚Äì</button>'+
              '<span id="q-'+k+'" style="min-width:34px;text-align:center;font-weight:800">'+state[k]+'</span>'+
              '<button class="btn" data-k="'+k+'" data-d="1">+</button></div></div>';
      });
      html+='</div>';
    });
    wrap.innerHTML=html;
    Array.prototype.forEach.call(wrap.querySelectorAll("button[data-k]"), function(b){
      b.addEventListener("click", function(){
        var key=this.getAttribute("data-k"); var d=parseInt(this.getAttribute("data-d"),10);
        state[key]=Math.max(0,(state[key]||0)+d);
        document.getElementById("q-"+key).textContent=state[key];
        calc();
      });
    });
  }
  function calc(){
    var t=0; Object.keys(PRICE).forEach(function(k){ t += (state[k]||0)*PRICE[k]; });
    document.getElementById("sum").textContent="Totale: "+t.toFixed(2)+"‚Ç¨";
  }

  function currentDay(){ return ymd(new Date()); }

  // ORDERS TABLE (read-only)
  function renderOrders(arr){
    var day = document.getElementById("dayInput").value;
    var vis = arr.filter(function(o){ return !o.deleted && (o.day||"")===day; });
    vis.sort(function(a,b){ return (b.createdAt && b.createdAt.seconds || 0) - (a.createdAt && a.createdAt.seconds || 0); });
    var html = '<table><thead><tr><th>Ora</th><th>Tavolo</th><th>Cameriere</th><th>Dettagli</th><th>Totale</th><th>Stato</th></tr></thead><tbody>';
    vis.forEach(function(o){
      var items=(o.items||[]).map(function(i){return i.qty+'√ó '+i.name;}).join('<br>');
      var cls=(o.status==='in_attesa'||o.status==='pronto')?'blink':'';
      html+='<tr class="'+cls+'"><td>'+fmtTime(o.createdAt)+'</td><td style="font-weight:900;font-size:20px">'+(o.table||'')+'</td><td>'+(o.waiter||'')+'</td><td>'+(o.status==='in_attesa'?'<span class="dot red"></span>':(o.status==='pronto'?'<span class="dot green"></span>':''))+' '+items+'</td><td><b>'+(Number(o.total||0).toFixed(2))+'‚Ç¨</b></td><td>'+(o.status||'')+'</td></tr>';
    });
    html+='</tbody></table>';
    document.getElementById("orders").innerHTML=html;
  }

  // Firestore stream
  var qRef = query(collection(db,"orders"), where("eventCode","==",EVENT_CODE));
  onSnapshot(qRef, function(snap){
    var data = snap.docs.map(function(d){ var v=d.data(); v.id=d.id; return v; });
    window.__ORDERS=data;
    renderOrders(data);
  });

  // Init
  document.getElementById("dayInput").value = currentDay();
  document.getElementById("dayInput").addEventListener("change", function(){ if(window.__ORDERS) renderOrders(window.__ORDERS); });

  renderMenu(); calc();

  document.getElementById("addBtn").addEventListener("click", async function(){
    var w=document.getElementById("waiterInput").value.trim();
    var t=document.getElementById("tableInput").value.trim();
    if(!w||!t){ alert("Inserisci nome cameriere e tavolo"); return; }
    var items=[]; var total=0;
    Object.keys(PRICE).forEach(function(k){ var q=state[k]||0; if(q>0){ items.push({key:k,name:NAME[k],qty:q,price:PRICE[k]}); total+=q*PRICE[k]; state[k]=0; var el=document.getElementById('q-'+k); if(el) el.textContent='0'; } });
    if(items.length===0){ alert("Aggiungi almeno una quantit√†"); return; }
    calc();
    await addDoc(collection(db,"orders"), {waiter:w, table:t, items:items, total:total, status:"in_attesa", eventCode:EVENT_CODE, deleted:false, day:document.getElementById("dayInput").value, createdAt: serverTimestamp()});
    document.getElementById("tableInput").value="";
    alert("Ordine inserito ‚úÖ");
  });
</script>
</body></html>
